#!/bin/sh
# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2023 JELOS (https://github.com/JustEnoughLinuxOS)

. /storage/.config/profile.d/001-device_config

# RK3566 devices have a master volume attached to card 0 that needs to be set to 100% on startup.
amixer -c 1 set "Master" "100%"

# after virtual device added, we need to set the real device volume to maximum, so grab the real device id
number=$(wpctl status | grep -m 1 "Built-in Audio Headphones" | grep -Eo '[0-9]+' | awk 'NR==1{print; exit}')

# RK3566-X55 case
if [ -n "$number" ]; then
  number=$(wpctl status | grep -m 1 "Built-in Audio Internal" | grep -Eo '[0-9]+' | awk 'NR==1{print; exit}')
fi

if [ -n "$number" ]; then
  # Set the volume to 100% with the extracted id 
  wpctl set-volume "$number" 1
  echo "Default set to $number"
else
  echo "Error: Unable to extract number from command output."
fi

# start virtual audio driver

VAUDIODRV=$(get_setting audio.v-driver)

if [ -z "${VAUDIODRV}" ]
then
  /usr/bin/audio_vdriver.sh --start
else
  /usr/bin/audio_vdriver.sh ${VAUDIODRV}
fi
